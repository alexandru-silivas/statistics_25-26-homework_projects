//------------------------------------------------------------
// Utilities
//------------------------------------------------------------

// Simulate one random walk
function simulateWalk(weeks, m, p, forceBalanced = false) {
  const s = forceBalanced ? 0.5 : Math.pow(1 - p, m);
  let score = 0;
  const path = [];

  for (let w = 0; w < weeks; w++) {
    const survive = Math.random() < s;
    score += survive ? 1 : -1;
    path.push(score);
  }
  return path;
}

// Run many simulations and return their final scores
function simulateMany(weeks, m, p, sims, forceBalanced = false) {
  const scores = [];
  const trajs = [];

  for (let i = 0; i < sims; i++) {
    const t = simulateWalk(weeks, m, p, forceBalanced);
    trajs.push(t);
    scores.push(t[t.length - 1]);
  }
  return { scores, trajs };
}

// Create histogram bin counts for discrete integer scores
function histogram(scores) {
  const counts = {};
  scores.forEach(s => counts[s] = (counts[s] || 0) + 1);
  const keys = Object.keys(counts).map(k => parseInt(k)).sort((a, b) => a - b);
  return {
    labels: keys,
    values: keys.map(k => counts[k])
  };
}

// Theoretical binomial distribution for final score: 
// S = (#survives) - (#fails) = 2X - n,  where X ~ Bin(n, s)
function theoreticalDistribution(weeks, m, p, forceBalanced = false) {
  const s = forceBalanced ? 0.5 : Math.pow(1 - p, m);

  // Binomial PMF
  function pmf(k, n, p) {
    function nCk(n, k) {
      if (k < 0 || k > n) return 0;
      let r = 1;
      for (let i = 1; i <= k; i++) {
        r *= (n - (k - i));
        r /= i;
      }
      return r;
    }
    return nCk(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
  }

  const scores = [];
  const probs = [];

  for (let x = 0; x <= weeks; x++) {
    const score = 2 * x - weeks;
    scores.push(score);
    probs.push(pmf(x, weeks, s));
  }
  return { scores, probs };
}

//------------------------------------------------------------
// Chart helpers
//------------------------------------------------------------

function drawTrajectories(canvasId, trajs) {
  const ctx = document.getElementById(canvasId).getContext("2d");
  const labels = Array.from({ length: trajs[0].length }, (_, i) => i + 1);

  return new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: trajs.map(t => ({
        data: t,
        borderWidth: 1,
        borderColor: "rgba(78,163,255,0.35)",
        fill: false
      }))
    },
    options: {
      animation: false,
      scales: {
        x: { ticks: { color: "#cfd9e6" } },
        y: { ticks: { color: "#cfd9e6" }, min: -50, max: 50 }
      },
      plugins: { legend: { display: false } }
    }
  });
}

function drawHistogram(canvasId, hist, theory) {
  const ctx = document.getElementById(canvasId).getContext("2d");

  return new Chart(ctx, {
    type: "bar",
    data: {
      labels: hist.labels,
      datasets: [
        {
          label: "Final scores",
          data: hist.values,
          backgroundColor: "rgba(78,163,255,0.85)"
        },
        {
          type: "line",
          label: "Theoretical",
          data: theory.probs.map(x => x * 100), 
          borderColor: "rgba(255,80,120,0.9)",
          borderWidth: 2,
          fill: false,
          yAxisID: "y1"
        }
      ]
    },
    options: {
      animation: false,
      scales: {
        x: { ticks: { color: "#cfd9e6" } },
        y: { ticks: { color: "#cfd9e6" } },
        y1: {
          position: "right",
          ticks: { color: "#cfd9e6" }
        }
      }
    }
  });
}

//------------------------------------------------------------
// PANEL A
//------------------------------------------------------------

(function loadPanelA() {
  const weeks = 50, m = 1, p = 0.05, sims = 80;
  const { scores, trajs } = simulateMany(weeks, m, p, sims);
  const hist = histogram(scores);
  const theory = theoreticalDistribution(weeks, m, p);

  drawTrajectories("trajA", trajs.slice(0, 50));
  drawHistogram("histA", hist, theory);
})();

//------------------------------------------------------------
// PANEL B
//------------------------------------------------------------

(function loadPanelB() {
  const weeks = 50, m = 50, p = 0.05, sims = 80;
  const { scores, trajs } = simulateMany(weeks, m, p, sims, true);
  const hist = histogram(scores);
  const theory = theoreticalDistribution(weeks, m, p, true);

  drawTrajectories("trajB", trajs.slice(0, 50));
  drawHistogram("histB", hist, theory);
})();

//------------------------------------------------------------
// PANEL C
//------------------------------------------------------------

(function loadPanelC() {
  const weeks = 50, m = 50, p = 0.05, sims = 500;
  const { scores, trajs } = simulateMany(weeks, m, p, sims, false);
  const hist = histogram(scores);
  const theory = theoreticalDistribution(weeks, m, p);

  drawTrajectories("trajC", trajs.slice(0, 50));
  drawHistogram("histC", hist, theory);
})();

//------------------------------------------------------------
// INTERACTIVE PANEL
//------------------------------------------------------------

function runInteractive() {
  const weeks = Number(i_weeks.value);
  const m = Number(i_m.value);
  const p = Number(i_p.value);
  const sims = Number(i_sims.value);

  const { scores, trajs } = simulateMany(weeks, m, p, sims);
  const hist = histogram(scores);
  const theory = theoreticalDistribution(weeks, m, p);

  drawTrajectories("trajI", trajs.slice(0, 50));
  drawHistogram("histI", hist, theory);
}
